# iEnvs Hosts 管理功能 PRD

## 1. 功能概述

在 iEnvs 应用中添加 `/etc/hosts` 文件管理能力，允许用户通过图形界面创建和管理 hosts 条目分组，实现一键启用/禁用不同的 hosts 配置场景。

### 1.1 目标用户

- 需要频繁切换开发/测试/生产环境的开发者
- 需要屏蔽广告或访问特定网站的用户
- 需要管理多个项目不同域名映射的用户

### 1.2 核心价值

- **可视化管理**：图形界面管理 hosts 条目，无需手动编辑文本文件
- **分组切换**：按场景分组，一键启用/禁用整组配置
- **安全可靠**：自动备份、冲突检测、原子写入
- **无缝集成**：与现有环境变量管理功能共享统一界面

## 2. 用户故事

### 2.1 基础管理

**故事 1：创建 Hosts 分组**
> 作为开发者，我想创建一个名为"本地开发"的 hosts 分组，用于存放所有开发环境的域名映射，这样我可以统一管理本地开发配置。

**故事 2：添加 Hosts 条目**
> 作为开发者，我想在"本地开发"分组中添加 `127.0.0.1 api.test.com` 条目，这样我可以将测试域名指向本地服务器。

**故事 3：编辑 Hosts 条目**
> 作为开发者，我想修改某个 hosts 条目的 IP 地址，因为我的测试服务器地址变更了。

**故事 4：删除 Hosts 条目**
> 作为开发者，我想删除过期的 hosts 条目，保持配置清洁。

### 2.2 启用与禁用

**故事 5：启用 Hosts 分组**
> 作为开发者，我想启用"本地开发"分组，系统应该将该分组的所有条目写入 `/etc/hosts` 文件，并自动刷新 DNS 缓存。

**故事 6：禁用 Hosts 分组**
> 作为开发者，我想禁用"本地开发"分组，系统应该从 `/etc/hosts` 中移除该分组的条目，恢复为系统默认配置。

**故事 7：切换不同场景**
> 作为开发者，我想快速在"本地开发"、"测试环境"、"生产环境"三个 hosts 分组之间切换，每次切换时系统应自动更新 `/etc/hosts` 并刷新 DNS。

### 2.3 冲突处理

**故事 8：检测冲突**
> 作为用户，当我尝试启用包含重复域名的多个分组时，系统应该提示我存在冲突，并显示冲突的具体条目。

**故事 9：解决冲突**
> 作为用户，当检测到冲突时，我希望看到清晰的冲突列表（哪些域名在哪些分组中重复），以便我手动调整配置。

### 2.4 导入与导出

**故事 10：导出配置**
> 作为用户，我想将当前所有 hosts 分组导出为 JSON 文件，以便在其他设备上导入或备份配置。

**故事 11：导入配置**
> 作为用户，我想从 JSON 文件导入 hosts 配置，快速恢复我的配置环境。

**故事 12：导入现有 hosts 文件**
> 作为新用户，我想导入我现有的 `/etc/hosts` 文件内容到 iEnvs 中，避免重复手动录入。

**故事 13：导出为标准 hosts 格式**
> 作为用户，我想将某个分组导出为标准 hosts 文件格式，以便分享给团队成员或用于其他工具。

## 3. 功能需求

### 3.1 Hosts 分组管理

| 功能 | 描述 | 优先级 |
|------|------|--------|
| FR-1.1 创建分组 | 用户可以创建新的 hosts 分组，指定名称和描述 | P0 |
| FR-1.2 编辑分组 | 用户可以修改分组名称和描述 | P0 |
| FR-1.3 删除分组 | 用户可以删除分组（需二次确认） | P0 |
| FR-1.4 分组排序 | 用户可以拖拽调整分组显示顺序 | P1 |
| FR-1.5 分组颜色标记 | 用户可以为分组设置颜色标签 | P2 |

### 3.2 Hosts 条目管理

| 功能 | 描述 | 优先级 |
|------|------|--------|
| FR-2.1 添加条目 | 在分组中添加新的 hosts 条目（IP + 域名） | P0 |
| FR-2.2 编辑条目 | 修改条目的 IP 地址或域名 | P0 |
| FR-2.3 删除条目 | 删除指定条目 | P0 |
| FR-2.4 批量添加 | 支持一次性粘贴多行 hosts 条目 | P1 |
| FR-2.5 条目注释 | 为条目添加备注说明 | P1 |
| FR-2.6 条目搜索 | 在当前分组内搜索条目 | P2 |

### 3.3 启用与同步

| 功能 | 描述 | 优先级 |
|------|------|--------|
| FR-3.1 启用分组 | 将分组条目写入 `/etc/hosts` 文件 | P0 |
| FR-3.2 禁用分组 | 从 `/etc/hosts` 文件中移除分组条目 | P0 |
| FR-3.3 自动刷新 DNS | 启用/禁用分组后自动执行 `dscacheutil -flushcache` | P0 |
| FR-3.4 权限处理 | 通过 AppleScript 弹出系统密码框获取 sudo 权限 | P0 |
| FR-3.5 标记块管理 | 使用 UUID 标记块标识不同分组的条目 | P0 |
| FR-3.6 状态同步 | 应用启动时检测 `/etc/hosts` 内容，同步分组启用状态 | P1 |

### 3.4 冲突检测

| 功能 | 描述 | 优先级 |
|------|------|--------|
| FR-4.1 域名冲突检测 | 检测同一域名在多个已启用分组中的重复定义 | P0 |
| FR-4.2 冲突提示 | 启用分组前，如果存在冲突则弹出警告对话框 | P0 |
| FR-4.3 冲突详情 | 显示冲突域名、涉及的分组、不同的 IP 地址 | P0 |
| FR-4.4 冲突图标 | 在分组列表中标记存在冲突的分组 | P1 |

### 3.5 导入与导出

| 功能 | 描述 | 优先级 |
|------|------|--------|
| FR-5.1 导出为 JSON | 导出所有 hosts 配置为 JSON 格式 | P0 |
| FR-5.2 从 JSON 导入 | 从 JSON 文件导入 hosts 配置 | P0 |
| FR-5.3 导出为 hosts 格式 | 导出单个分组为标准 hosts 文件格式 | P1 |
| FR-5.4 导入 hosts 文件 | 解析并导入现有 hosts 文件内容 | P1 |
| FR-5.5 导入时冲突处理 | 导入时检测重复条目，提供跳过/覆盖/合并选项 | P1 |

### 3.6 备份与恢复

| 功能 | 描述 | 优先级 |
|------|------|--------|
| FR-6.1 自动备份 | 每次修改 `/etc/hosts` 前自动备份原文件 | P0 |
| FR-6.2 手动恢复 | 用户可以从备份列表中恢复指定版本 | P1 |
| FR-6.3 备份清理 | 自动清理超过 30 天的旧备份 | P2 |

## 4. 非功能需求

### 4.1 性能要求

| 指标 | 要求 |
|------|------|
| NFR-1.1 启用/禁用响应时间 | < 2 秒（包括写入文件和刷新 DNS） |
| NFR-1.2 冲突检测时间 | < 500ms |
| NFR-1.3 大规模条目支持 | 单个分组支持至少 500 条 hosts 条目 |
| NFR-1.4 应用启动时间 | 加载 hosts 数据不应增加超过 200ms 启动时间 |

### 4.2 安全性要求

| 要求 | 描述 |
|------|------|
| NFR-2.1 权限隔离 | 只在必要时（启用/禁用分组）请求 sudo 权限 |
| NFR-2.2 输入验证 | 验证 IP 地址格式（IPv4/IPv6）和域名格式 |
| NFR-2.3 原子写入 | 使用临时文件 + 原子替换模式修改 `/etc/hosts` |
| NFR-2.4 备份保护 | 备份文件权限与原文件保持一致（600） |
| NFR-2.5 恶意输入防护 | 防止注入换行符或特殊字符破坏 hosts 文件结构 |

### 4.3 可用性要求

| 要求 | 描述 |
|------|------|
| NFR-3.1 界面一致性 | Hosts 管理界面与环境变量管理界面保持一致的交互模式 |
| NFR-3.2 错误提示 | 所有错误操作提供清晰的中文错误提示 |
| NFR-3.3 操作反馈 | 长时间操作（如刷新 DNS）显示进度指示器 |
| NFR-3.4 快捷键支持 | 支持常用操作的键盘快捷键 |

### 4.4 兼容性要求

| 要求 | 描述 |
|------|------|
| NFR-4.1 macOS 版本 | 支持 macOS 13.0+（Ventura 及以上） |
| NFR-4.2 现有 hosts 兼容 | 保留用户在 iEnvs 标记块之外手动添加的 hosts 条目 |
| NFR-4.3 Shell 兼容 | 支持 zsh 和 bash 环境下的 DNS 刷新 |

## 5. 界面设计要点

### 5.1 主界面布局

- **顶部 Tab 切换**：在侧边栏顶部添加"环境变量"和"Hosts"两个 Tab
- **侧边栏**：显示 Hosts 分组列表，每个分组显示启用状态（开关）、名称、条目数量
- **详情面板**：显示选中分组的所有 hosts 条目，支持增删改操作
- **工具栏**：添加分组、导入、导出、设置按钮

### 5.2 关键交互

- **拖拽排序**：侧边栏分组支持拖拽调整顺序
- **开关切换**：点击分组的开关可直接启用/禁用
- **双击编辑**：双击条目进入编辑模式
- **右键菜单**：分组和条目都提供右键操作菜单

### 5.3 对话框

- **冲突提示对话框**：列出冲突的域名、涉及分组、不同 IP 地址
- **导入对话框**：选择导入格式（JSON/hosts 文件）、处理冲突策略
- **删除确认对话框**：删除分组或条目时二次确认

## 6. 技术约束

| 约束 | 描述 |
|------|------|
| TC-1 权限模型 | 使用 AppleScript 调用 `do shell script ... with administrator privileges` |
| TC-2 文件路径 | `/etc/hosts` 文件路径固定，不可配置 |
| TC-3 标记格式 | 使用 `# [iEnvsHosts:{UUID}] START/END - GroupName` 标记块 |
| TC-4 数据存储 | 扩展现有 `AppData` 模型，添加 `hostGroups` 字段 |
| TC-5 备份路径 | 备份存储在 `~/Library/Application Support/iEnvs/backups/hosts/` |

## 7. 验收标准

### 7.1 基础功能验收

- [ ] 可以创建、编辑、删除 hosts 分组
- [ ] 可以在分组中添加、编辑、删除 hosts 条目
- [ ] 启用分组后，条目正确写入 `/etc/hosts` 文件
- [ ] 禁用分组后，条目从 `/etc/hosts` 文件中移除
- [ ] 启用/禁用操作后自动刷新 DNS 缓存
- [ ] 使用 `ping` 或浏览器验证 hosts 条目生效

### 7.2 冲突检测验收

- [ ] 启用包含重复域名的分组时弹出冲突警告
- [ ] 冲突对话框正确显示冲突域名和涉及的分组
- [ ] 用户选择取消时，分组启用操作被回滚

### 7.3 导入导出验收

- [ ] 导出的 JSON 文件格式正确，可重新导入
- [ ] 导出的 hosts 文件格式符合标准，可被系统识别
- [ ] 导入现有 hosts 文件时正确解析 IP 和域名
- [ ] 导入时检测到重复条目并提供处理选项

### 7.4 安全性验收

- [ ] 修改 `/etc/hosts` 前自动创建备份
- [ ] 使用原子写入模式，不存在文件损坏风险
- [ ] 保留用户在 iEnvs 标记块之外手动添加的内容
- [ ] 输入非法 IP 或域名时显示错误提示

### 7.5 用户体验验收

- [ ] Hosts 管理界面与环境变量管理界面风格一致
- [ ] 所有错误提示使用中文且描述清晰
- [ ] 长时间操作显示进度指示器
- [ ] 应用重启后分组启用状态与 `/etc/hosts` 内容保持一致

## 8. 发布计划

### 8.1 MVP 范围（v1.1.0）

- FR-1.1 ~ FR-1.3（分组基础管理）
- FR-2.1 ~ FR-2.3（条目基础管理）
- FR-3.1 ~ FR-3.5（启用同步核心功能）
- FR-4.1 ~ FR-4.3（基础冲突检测）
- FR-5.1 ~ FR-5.2（JSON 导入导出）
- FR-6.1（自动备份）

### 8.2 后续迭代

- v1.2.0：导入导出增强（hosts 文件格式支持）
- v1.3.0：高级功能（批量添加、条目注释、搜索）
- v1.4.0：体验优化（分组排序、颜色标记、快捷键）

## 9. 风险与依赖

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| AppleScript 权限授权失败 | 无法写入 `/etc/hosts` | 提供详细错误提示和手动操作指引 |
| DNS 缓存刷新命令在某些系统版本失效 | hosts 条目不立即生效 | 执行多个刷新命令组合，提供手动刷新按钮 |
| 用户手动修改 iEnvs 标记块内容 | 分组状态与文件内容不同步 | 启动时检测并提示修复 |
| 大量 hosts 条目导致性能问题 | 界面卡顿 | 实施虚拟化列表、分页加载 |

## 10. 附录

### 10.1 术语表

| 术语 | 定义 |
|------|------|
| Hosts 条目 | 一条 IP 地址到域名的映射记录，如 `127.0.0.1 localhost` |
| Hosts 分组 | 包含多个 hosts 条目的逻辑集合，可以整体启用或禁用 |
| 标记块 | 在 `/etc/hosts` 文件中用特殊注释标识的内容区域 |
| DNS 缓存 | 操作系统缓存的域名解析结果 |
| 冲突 | 同一域名在多个已启用分组中指向不同 IP 地址 |

### 10.2 参考资料

- [Hosts 文件格式标准](https://en.wikipedia.org/wiki/Hosts_(file))
- [macOS DNS 缓存刷新方法](https://support.apple.com/en-us/HT202516)
- [AppleScript 管理员权限执行](https://developer.apple.com/library/archive/technotes/tn2065/)
